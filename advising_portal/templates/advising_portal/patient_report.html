{% extends "advising_portal/base.html" %}
{% load static %}
{% load custom_tags %}
{% block content %}
    <div class="row">
        <div class="semesters-dropdown-menu col-8">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle w-50" type="button" id="dropdownMenuButton"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {{ patient_name }}
                </button>
                <div class="dropdown-menu w-50" aria-labelledby="dropdownMenuButton">
                    {% for patient in patients %}
                        <a class="dropdown-item"
                           href="{% url 'lab-patient-report' %}?patient_id={{ patient.patient_id }}">{{ patient.name }}</a>
                    {% endfor %}
                </div>
            </div>
        </div>

{#        {% if user|has_group:"chairman" %}#}
{#            <div class="col-4" align="right">#}
{#                <a href="{% url 'faculty-panel-course-create' %}"#}
{#                   class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">#}
{#                    <i class="fas fa-download fa-sm text-white-50"></i>Create Course</a>#}
{#            </div>#}
{#        {% endif %}#}
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="row">
              <div class="col-6"><strong>Patient ID</strong></div>
              <div class="col-6">{{ patient_id }}</div>
            </div>
            <div class="row">
              <div class="col-6"><strong>Name</strong></div>
              <div class="col-6">{{ patient_name }}</div>
            </div>
            <div class="row">
              <div class="col-6"><strong>Age</strong></div>
              <div class="col-6">{{ age }}</div>
            </div>
            <div class="row">
              <div class="col-6"><strong>Gender</strong></div>
              <div class="col-6">{{ gender }}</div>
            </div>
        </div>

        <div class="col-md-12 col-lg-12">
            <div class="table-responsive card shadow custom-left-table-align">
                <table id="myTable" class="table table-striped">
                    <tbody>
                    <tr>
                        <th class="col-md-1"><b>Test ID</b></th>
                        <th class="col-md-1"><b>Heart Rate</b></th>
                        <th class="col-md-1"><b>Oxygen Sat</b></th>
                        <th class="col-md-1"><b>Temp</b></th>
                        <th class="col-md-1"><b>SBP</b></th>
                        <th class="col-md-1" hidden><b>Patient ID</b></th>
                        <th class="col-md-1"><b>Generate</b></th>
                    </tr>

                    {% for data in patient_stats %}

                        <tr>
                            <td class="col-md-1 test-id">{{ data.test_id }}</td>
                            <td class="col-md-1">{{ data.HR }}</td>
                            <td class="col-md-1">{{ data.O2Sat }}</td>
                            <td class="col-md-1">{{ data.Temp }}</td>
                            <td class="col-md-1">{{ data.SBP }}</td>
                            <td class="col-md-1 patient-id" hidden>{{ data.patient_id }}</td>
                            <td class="col-md-1">
                                <button class="btn btn-outline-danger" type="submit">
                                    Report
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add this modal section at the end of the template -->
    <div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel"><strong>Medical Report</strong></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="reportContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

{#    <div id="myElement" data-csrf-token="{% csrf_token %}"></div>#}

    <script>
        // Function to handle the AJAX request for generating the report
        function generateReport(patientId, testId) {
            console.log(patientId);
            console.log(testId);

            const url = "{% url 'generate-report' %}?patient_id=" + patientId + "&test_id=" + testId;

            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the content of the modal with the report data
                    const reportContent = document.getElementById('reportContent');
                    reportContent.textContent = JSON.stringify(data.report, null, 2);
                    // Show the modal
                    const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
                    reportModal.show();
                } else {
                    // Handle error if needed
                    console.error(data.error);
                }
            })
            .catch(error => {
                // Handle error if needed
                console.error(error);
            });
        }

        // Attach a click event listener to the "Report" buttons in the table
        const reportButtons = document.querySelectorAll('.btn-outline-danger');
        reportButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Get the patient ID and test ID from the button's row
                const patientId = button.closest('tr').querySelector('.patient-id').textContent;
                const testId = button.closest('tr').querySelector('.test-id').textContent;

                // Call the function to generate the report
                generateReport(patientId, testId);
            });
        });
    </script>

{% endblock content %}
